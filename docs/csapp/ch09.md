# ch09 虚拟内存

## 9.1 物理和虚拟寻址

- **物理地址**：计算机的主存被组织成连续的字节单元组成的数组。每个字节都有唯一的物理地址
- **物理寻址**：CPU使用物理地址直接访问内存的方式
- **虚拟地址**：主存进行抽象，为每个进程提供大小一致的、私有的地址空间
- **虚拟寻址**：CPU通过一个虚拟地址访问内存，虚拟地址通过**地址翻译**转化为适当的物理地址

![image-20230104212756659](https://cdn.docjerry.top/csapp/image-20230104212756659.png)

## 9.2 地址空间

- **地址空间(address space)**：非负整数地址的有序集合
- **线性地址空间**：地址空间的整数是连续的。为了简化讨论，总是假设是线性的
- **物理地址空间**：由$M$个字节的物理内存组成的地址空间。这里$M$不要求是2的幂
$$
\{0,1,2,...,M-1\}
$$
- **虚拟地址空间**：每个进程由$2^n$个字节组成的虚拟地址空间。其中$n$表示32位或64位系统
$$
\{0,1,2,...,2^n-1\}
$$

## 9.3 虚拟内存作为缓存

- **虚拟页VP（简称页, page）**：虚拟内存分割成固定大小的块。页大小是$P=2^p$字节，Linux中默认是4096字节（`getconf PAGESIZE`）
- **物理页PP（简称页帧, page frame）**：物理内存分割成固定大小的块。页帧大小是$P=2^p$字节
- **页表（Page Table）**：虚拟页通过页表的数据结构映射到物理页。页表由**页表项（PTE, Page Table Entry）** 组成
  - **页表项**：包含页帧地址以及控制位，控制位包含 **有效位(valid bit)** 表明当前虚拟页是否被保存在内存中

![image-20230104220838507](https://cdn.docjerry.top/csapp/image-20230104220838507.png)

【说明】上图中的页表指明4个页(`VP1`, `VP2`, `VP4`, `VP7`)缓存在内存中；2个页(`VP0`, `VP5`)还未分配；2个页(`VP3`, `VP6`)已经被分配了，但是还未缓存在内存里。考虑以下操作：

- **页命中**：以图9-4为例，如果进程访问`VP2`中的虚拟内存地址。由于**页表项是有效的**，此时页表将`VP2` **翻译**成物理页帧`PP1`，构造出这个字的物理地址
- **缺页**：如果进程访问`VP3`中的虚拟地址。由于**页表项无效**，所以引发**缺页异常**。此时内核从磁盘将`VP3`的页帧替换到物理内存中(假设位置是`PP3`)，再将`VP3`翻译成`PP3`，最后构造这个字的物理地址
  - **页面调度**：磁盘和内存之间，页面如何换入换出，涉及到**页面调度算法**。良好的调度算法遵循**局部性原理**，避免不断地换入换出（**抖动状态**）。参见操作系统相关书籍
- **分配页面**：比如调用`malloc`将在磁盘上创建空间并更新PTE

